<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>The amazing news summary page</title>
    <script src="https://rawgit.com/rogrenke/testFramework-js/master/helpers.js" type="text/javascript"></script>

  <link href="style.css" type="text/css" rel="stylesheet" >
  <script>
    var fullTextArray = [];
    var openLightbox = function(element) {
      var lightbox = document.getElementById('lightbox');
      var id = element.getAttribute("id");
      document.getElementById('article-view').innerHTML = fullTextArray[id-1];
      lightbox.style.visibility = 'visible';
      lightbox.onclick = function() {
        lightbox.style.visibility = 'hidden';
      };
    }

    function loadXMLDoc(callbackTest) {
      var xhttp = new XMLHttpRequest();
      var API_KEY = "1eb0ccf89bbb379a3905a8df22bb438a";
      var APP_ID = "36bbd38c";

     function textSummarize(url, callback) {

      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          callback(JSON.parse(this.responseText).sentences);
        }

      };

        xhttp.open("GET", "http://our-news-summary-api.herokuapp.com/aylien?apiRequestUrl=https://api.aylien.com/api/v1/summarize?url=" + url, true);
      xhttp.send();
    }

      xhttp.onreadystatechange = function() {

        if (this.readyState == 4 && this.status == 200) {
          var headline, category, date, bodyText;
          var sentences;
          var resp = JSON.parse(this.responseText);
          var count = resp.response.results.length;
          var news = document.getElementById("news");
          console.log(1);
          for(var i = 0; i < count; i++) {

            headline = resp.response.results[i].webTitle;
            category = resp.response.results[i].sectionName;
            date = resp.response.results[i].webPublicationDate;
            console.log(2);
            url = resp.response.results[i].webUrl;
            bodyText = resp.response.results[i].fields.bodyText;
            fullTextArray.push(bodyText);
            textSummarize(url, function(response) {
              // console.log(response);
              console.log(3)
              summary = response.join(" ");
              var article = document.createElement("article");
              var textContent = document.createElement("details");
              var lineBreak = document.createElement("br");
              var h = document.createElement("summary");
              var c = document.createElement("p");
              var s = document.createElement("p");
              // var d = document.createElement("p");

              h.setAttribute("class", "headline");
              c.setAttribute("class", "category");
              article.setAttribute("class", "article");
              s.setAttribute("onclick", "openLightbox(this)");
              s.setAttribute("id", i);
              // d.setAttribute("class", "date");

              h.innerHTML = headline;
              c.innerHTML = category + " - " + new Date(date).toUTCString();
              s.innerHTML = summary;
              // d.innerHTML = ""

              news.appendChild(article);
              article.appendChild(c);
              article.appendChild(textContent);
              // news.appendChild(d);
              textContent.appendChild(h);
              textContent.appendChild(s);

              article.appendChild(lineBreak);


            });
          }
          console.log(fullTextArray);
          callbackTest();
        }
      };

      xhttp.open("GET", "http://content.guardianapis.com/search?show-fields=bodyText&api-key=fe308324-ad4f-4317-a3df-7329ed2b238b", true);
      xhttp.send();

    }

    </script>

</head>
<body onload="loadXMLDoc(executeTests)">



  <h1 id="header">See the latest news!</h1>
  <div id="news">

  </div>

  <div id="lightbox">
      <div class="inner">
          <p id="article-view"></p>
      </div>
  </div>

  <script src="test/featureTest.js" type="text/javascript"></script>



</body>
</html>
